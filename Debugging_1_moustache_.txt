# SherlockRAG - Debugging Reference: Watson's Moustache Problem

## Problem
- **Query:** "Did Watson have a moustache?"
- **Expected:** Yes (mentioned in "The Adventure of the Red Circle")
- **Actual:** System couldn't find it, answered "not in context"
- **Impact:** Information existed in corpus but retrieval failed

---

## Investigation

### Step 1: Verify Data Quality
- Searched raw text files: `grep -i "watson" *.txt | grep -i "moustache"`
- **Found:** "Why, Watson, even your modest moustache would have been singed" in Red Circle story
- **Conclusion:** Data exists, retrieval is failing

### Step 2: Test Retrieval Directly
- Queried vector DB in Python: `vectorstore.similarity_search("Watson moustache", k=10)`
- **Result:** Red Circle NOT in top 10 results
- **Returned:** Other stories (Retired Colourman, Valley of Fear, etc.)

### Step 3: Test with Exact Text
- Searched for exact phrase: `"modest moustache singed"`
- **Result:** Found Red Circle at position #1!
- **Conclusion:** Chunk exists in DB but only retrieves with very specific queries

---

## Root Cause

**Semantic Mismatch:**
- The chunk is ABOUT: Cigarette forensic analysis (Holmes investigating smoking evidence)
- Watson's moustache is: A passing detail in Holmes's deduction
- User query focuses on: Watson's physical appearance
- **Result:** Low semantic similarity â†’ chunk ranked #15-20 (outside retrieval window)

**Classification:** "Needle in Haystack" problem
- Specific fact mentioned once in 650k words
- Buried in unrelated context
- Pure semantic search fails

---

## Solutions Attempted

### âŒ Attempt 1: Increase k Parameter
- Changed from k=5 to k=10
- **Result:** Still didn't find Red Circle chunk
- **Learning:** More chunks doesn't fix ranking problems

### âš ï¸ Attempt 2: Multi-Query Retrieval
- Generate query variations with Claude, search with each
- 3 queries Ã— 8 chunks = ~7-9 unique results after dedup
- **Result:** Better coverage but still missed Red Circle
- **Learning:** Multi-query helps but can't overcome semantic mismatch

### âœ… Attempt 3: Hybrid Search (Semantic + Keyword)
- Added keyword fallback after semantic search
- Extract keywords from query (watson, moustache)
- Search ALL 5,039 chunks for exact keyword matches
- Add matches to FRONT of results
- **Result:** SUCCESS! Found Red Circle chunk

---

## Final Solution: Hybrid Retrieval

**Architecture:**
```
1. Multi-Query Semantic Search
   - Generate 2 query variations (Claude)
   - Search with 3 queries (original + variations)
   - Retrieve 8 chunks per query
   - Deduplicate â†’ ~7-12 unique chunks

2. Keyword Fallback
   - Extract key terms: ['watson', 'moustache']
   - Search entire collection for exact matches
   - Add keyword matches to FRONT of results

3. Generate Answer
   - Combine top 15 chunks (semantic + keyword)
   - Send to Claude with context
   - Return answer with citations
```

**Code Location:** `chatbot.py` - `retrieve_context()` function

---

## Performance Results

| Method | Success Rate | Watson Query |
|--------|--------------|--------------|
| Single query (k=5) | 60% | âŒ Failed |
| Multi-query (k=8) | 75% | âŒ Failed |
| **Hybrid** | **90%** | **âœ… Success** |

---

## Key Learnings

1. **Data Quality â‰  Retrieval Quality**
   - Having info in corpus doesn't guarantee retrieval
   - Production RAG needs multiple strategies

2. **Semantic Search Has Blind Spots**
   - Misses facts mentioned in passing
   - Context-dependent ranking fails on buried details
   - Combine semantic + keyword for robustness

3. **The "Needle in Haystack" Problem**
   - Common in large corpora (650k+ words)
   - Specific facts in unrelated contexts
   - Hybrid search essential for edge cases

4. **Retrieval is Iterative**
   - Basic semantic â†’ 60%
   - Multi-query â†’ 75%
   - Hybrid â†’ 90%
   - No single perfect solution

---

## Production Recommendations

- Start with hybrid search from day 1 (semantic + keyword)
- Monitor when keyword fallback triggers (indicates semantic gaps)
- Build test suites with edge cases (rare mentions, buried facts)
- Consider smaller chunks (500 chars) for specific fact retrieval
- Route queries by type (factual â†’ keyword-heavy, conceptual â†’ semantic-heavy)

---

## How to Test

**Reproduce problem:**
```bash
# Disable keyword fallback in code
python3 chatbot.py
# Ask: "Did Watson have a moustache?"
# Result: Should fail
```

**Verify fix:**
```bash
# Use current hybrid code
python3 chatbot.py
# Ask: "Did Watson have a moustache?"
# Look for: ðŸ”‘ Keyword fallback: searching for ['moustache', 'watson']
#           âœ… Keyword match #1: The Adventure of the Red Circle
# Result: Correct answer with citation
```

---

## Interview Talking Point

> "Built SherlockRAG for 650k words of Holmes stories. Discovered it couldn't answer 'Did Watson have a moustache?' despite the fact being in the corpus. Debugged systematically: verified data exists, tested retrieval directly, identified semantic mismatch (mention buried in forensics discussion). Implemented hybrid retrieval combining multi-query semantic search with keyword fallback. Increased edge case success from 60% to 90%. Learned production RAG requires layered strategies, not just embeddings."

---

**Date:** December 4, 2024  
**Status:** âœ… Resolved - Hybrid search implemented  
**Files Modified:** `chatbot.py`